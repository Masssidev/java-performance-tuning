# 서버를 어떻게 세팅해야 할까?

### 설정해야 하는 대상
개발된 프로그램이 0.1초 걸린다고 해도 서버 세팅을 잘못하면 1초가 걸릴 수도 있고, 10초가 걸릴 수 있다. 이러한 문제를 진단하는 가장 좋은 방법은 성능 테스트를 
통해서 병목 지점을 미리 파악하는 것이다. 무조건 애플리케이션 위주로 병목을 찾는 것보다, 일단 문제가 될 만한 세팅 값을 먼저 진단하는 것이 가장 효율적이다.<br/>

웹 기반의 시스템에서 성능에 영향을 줄만한 세팅
* 웹 서버 세팅
* WAS 서버 세팅
* DB 서버 세팅
* 장비 세팅
<hr/>

### 아파치 웹 서버의 설정
WAS를 웹 서버로 사용하면 안된다. 웹 서버를 WAS 뒤에 둘 사람은 없겠지만, 웹 서버는 반드시 WAS 앞에 두어야 한다. 왜냐하면 WAS는 Web Application Server이기 때문이다.
 웹에서 사용하는 애플리케이션 서버이지 웹 서버가 아니다. 정적인 부분은 웹서버에서 처리해야 한다. 그렇지 않으면 WAS 서버에서 웹 서버의 역할까지 수행해야 한다. 
 웹 서버를 WAS 서버 앞에 두지 않으면 이미지, CSS, 자바 스크립트, HTML 등을 처리하느라 아까운 WAS 서버의 스레드를 점유하게 된다. 반드시 상용 웹 서버나 
 아파치 웹 서버를 WAS 앞 단에 두고 운영해야 한다.
 
아파치 웹 서버는 MPM(Multi-Processing-Module)을 사용한다. 여러 개의 프로세싱 모듈 기반의 서비스를 제공한다.
###### 아파치 웹 서버의 설정을 바꾸는 방법
* 설치 폴더 하단의 conf 디렉터리에 있는 httpd.conf 파일을 수정한다.
```
ThreadsPerChile 250
MaxRequestsPerChile 0
```
> ThreadsPerChild는 웹 서버가 사용하는 스레드의 개수를 지정한다.(위는 250개)<br/>
> 만약 이 수치가 적게 지정되어 있다면, 늘려 주어야 한다. 그래야 더 많은 사용자의 요청을 처리할 수 있게 된다.<br/>

> MaxRequestsPerChild는 최대 요청 개수를 지정한다. 0이면 그 수에 제한을 두지 않겠다는 의미다.(0을 권장)

###### 세밀하게 스레드 관련 지정
* httpd.conf 파일에서 #으로 주석 처리되어 있는 "Include conf/extra/httpd-mpm.conf"를 찾아서 주석을 해제한다.
* httpd-mpm.conf를 통해서 세밀한 스레드 설정 정보를 지정한다.
```
<IfModule mpm_worker_module>
StartServers 2
MaxClients 150
MinSpareThreads 25
MaxSpareThreads 75
ThreadsPerChile 25
MaxRequestsPerChild 0
</IfModule>
```
* StartServers: 서버를 띄울 때 프로세스의 개수를 지정한다. 보통 이야기하는 child 프로세스의 개수를 이야기한다.
* MaxClients: 최대 처리 가능한 클라이언트의 수를 지정한다.
* MinSpareThreads: 최소 여유 스레드 수를 지정한다.
* MaxSpareThreads: 최대 여유 스레드 수를 지정한다.
* ThreadsPerChild: 프로세스당 스레드 수를 지정한다.
* MaxRequestsPerChild: 앞서 이야기한 MaxRequestsPerChild와 같은 의미<br/>
> 여기에서는 프로세스 수가 2개이고, 프로세스당 스레드 수가 25이므로 기본적으로 50개의 요청을 처리할 수 있다. 또한 최대 여유 스레드가 75개이므로, 최대 사용 가능한 클라이언트 수는 
150이 된다. 이 서버는 150명이 최대다. 150명 이상의 요청은 서버 리소스에 여유가 있어도(팡팡 놀고 있어도) 처리를 안 한다.

###### 예시
위의 설정으로 되어 있을 경우 초당 150명의 요청을 받고 있다고 가정해보자. 이 상황에서 웹 서버에서 150명의 요청을 받고, 그 요청을 전달받은 WAS도 마찬가지로 
150명의 요청을 받는다. 그런데, 자바는 GC를 할 때 JVM 자체가 멈춘다. 만약 이 GC가 2초 걸리면 아파치 웹 서버에 총 300명의 요청이 기다리게 된다. 그런데 GC를 
하는 동안 WAS가 멈추기 때문에 새로운 연결을 할 수 없다. 이 경우 Tomcat에서는 AJP Connector라는 웹 서버와 WAS 사이의 커넥터에 설정한 blacklog라는 값의 
영향을 받는다. 만약 이 값을 설정하지 않으면 기본값은 100이다. 즉, WAS가 응답하지 않을 때 100개의 요청 까지 큐에 담아둔다. 따라서, 100개를 넘는 
요청들은 503이라는 HTTP 헤더 코드 값을 리턴 받게 된다. 

###### 조치
1. 서버를 늘린다: 어떻게 보면 가장 편한 방법이다. 금전적인 여유가 있을 때 말이다.
2. 서비스를 튜닝한다: 서비스가 응답이 안 되는 원인을 찾고 튜닝한다. 하지만 말이 쉽지 실제로 그 원일을 찾는 데는 몇 시간이 소요될 수도 있으며, 몇 달이 걸릴 수도 있다.
3. GC 튜닝을 한다: 만약 GC가 오래 소요되어 응답이 안될 경우 GC 튜닝을 한다.
4. 각종 옵션 값을 튜닝한다: 어떻게 보면 가장 간단한 방법일 수도 있다. 하지만, 잘못 설정할 경우 오히려 더 큰 문제가 야기될 수 있기 때문에 해당 웹 서버 및 
WAS의 전문가나 엔지니어와 같이 이야기해서 옵션 값을 설정해야 한다.
<hr/>

### 웹 서버의 Keep Alive
아파치 웹 서버의 경우, httpd.conf 파일에 다음의 설정이 없으면 간단하게 한 줄 추가하면 된다.
```
KeepAlive On
```
> 웹 서버와 웹 브라우저가 연결이 되었을 때 KeepAlive 기능이 켜져 있지 않으면, 매번 HTTP 연결을 맺었다 끊었다 하는 작업을 반복한다. 네이버나 다음과 같이 초기 
화면에서 엄청나게 많은 이미지와 CSS, 자바 스크립트 등의 파일을 받아야 하는 사이트에서 KeepAlive 옵션이 적용되어 있지 않다면, 초기 화면을 띄우는 데 
몇 분씩 소요될지도 모른다. 

KeepAlive 설정을 할 때 반드시 같이 해야 하는 <br/>
* KeepAliveTimeout
  * 초 단위로 KeepAlive가 끊기는 시간을 설정
```
KeepAliveTimeout 15
```
만약 사용자가 너무 많아 접속이 잘 안될 경우, 이 설정을 5초 정도로 짧게 주는 것도 서버의 리소스를 보다 효율적으로 사용할 수 있는 방법이다.<br/>
추가로 서비스의 상황에 따라서 KeepAlive 옵션을 껐을 때 보다 좋은 성능이 나오게 되는 경우가 존재한다. 무조건 KeepAlive를 켜야 한다는 것이 아니니 상황에 
맞게 사용해야 한다.
<hr/>

### DB Connection Pool 및 스레드 개수 설정
WAS에서 설정해야 하는 값은 너무나 많다. 그중 가장 성능에 많은 영향을 주는 것은 DB Connection Pool과 스레드 개수이다. 이 두 항목의 개수는 메모리와 관련이 있다. 많이 사용할수록 메모리를 많이 점유하게 된다. 그렇다고 메모리를 위해서 DB Connection Pool과 스레드 개수를 적게 지정하면, 서버에서는 많은 요청을 처리하지 못하고 대기할 수밖에 없다.

대부분의 WAS에서는 DB Connection Pool의 개수를 최소치, 증가치, 최대치 등으로 자세하게 지정할 수 있다. 최소치를 말 그대로 서버가 기동될 때 연결을 수행하는 개수이다. 개발자용 PC에서는 이 값이 높을 필요가 없으므로 이 값은 최소한으로 지정하자. 최소 개수가 많으면 많을수록 서버 기동하는 시간이 오래 소요되므로, 개발자가 디버그를 하기 위해서 여러 번 재기동을 할 때는 좋지 않다. 하지만 운영 중에는 최소 및 최대 값을 동일하게 하는 것이 좋다. 사용자 수가 갑자기 증가하면 DB Connection Pool의 개수도 증가되어야 하고, 증가할 때 대기 시간이 발생할 확률이 크기 때문이다. 만약 DB 서버의 리소스가 부족하다면 최소값을 적게 해 놓는 것도 한 방법이 될 수 있다.

대부분 WAS에서 두 설정 값의 기본 개수가 10,20개 정도이다. 따라서 기본 값으로 서비스를 오픈하면 서버가 원하는 요청량을 처리하지 못하게 된다. DB Connection Pool은 보통 40,50개로 지정하며, 스레드 개수는 이보다 10개 정도 더 지정한다. 이렇게 지정하는 이유는, 스레드 개수가 DB Connection Pool의 개수보다 적으면 적은 수만큼의 연결은 필요 없기 때문이다. 

> DB와 연동하는 프레임워크를 설정할 때는 Pool의 개수, Wait과 관련된 값이 들어간 값, Timeout관련 된 설정들을 시스템의 상황에 맞게 설정해야지만 예기치 못한 오류 페이지를 만나지 않는다.
<hr/>

### Session Timeout 시간 설정
WEB-INF 폴더 하단의 web.xml 파일에서 설정
```
<session-timeout>30</session-timeout>
```
> 세션 종료 시간 설정 값은 분 단위이다. 설정되어 있는 분만큼 요청이 없으면 세션을 메모리에서 제거한다. 이 설정을 하지 않은 상태에서, WAS에서 따로 설정한 바가 없거나 세션 객체의 invalidate()메서드가 수행되지 않으면 세션은 삭제되지 않으므로 유의해야 한다.
